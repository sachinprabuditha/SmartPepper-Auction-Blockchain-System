openapi: 3.0.3
info:
  title: SmartPepper Auction API
  description: |
    # SmartPepper Auction Blockchain System API
    
    RESTful API for the SmartPepper blockchain-based pepper auction platform.
    Enables pepper farmers to register lots, run compliant auctions, and connect
    with exporters globally with full traceability and regulatory compliance.
    
    ## Features
    - üå∂Ô∏è **Lot Registration**: Register pepper lots with full traceability
    - üîç **Compliance Validation**: Automated checks for EU, FDA, Middle East markets
    - üèÜ **Real-Time Auctions**: WebSocket-based live bidding
    - üì¶ **IPFS Integration**: Immutable certificate storage
    - ‚õìÔ∏è **Blockchain**: Smart contract integration for transparency
    
    ## Authentication
    Currently uses wallet address verification. Production should implement JWT tokens.
    
    ## Rate Limits
    - General endpoints: 100 requests/minute
    - Bid placement: 10 bids/minute per address
    
    ## WebSocket
    Real-time auction updates available at `/auction` namespace.
    See WebSocket documentation for event details.
    
  version: 1.0.0
  contact:
    name: SmartPepper Team
    email: support@smartpepper.io
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3002/api
    description: Development server
  - url: https://api.smartpepper.io/api
    description: Production server

tags:
  - name: Lots
    description: Pepper lot management and traceability
  - name: Auctions
    description: Auction creation and bidding operations
  - name: Compliance
    description: Regulatory compliance validation
  - name: Users
    description: User profile management
  - name: Certifications
    description: Certificate document management with IPFS

paths:
  # ==================== LOTS ====================
  /lots:
    get:
      tags:
        - Lots
      summary: Get all pepper lots
      description: Retrieve a paginated list of pepper lots with optional filters
      parameters:
        - name: status
          in: query
          description: Filter by lot status
          schema:
            type: string
            enum: [available, in_auction, sold, expired]
        - name: farmer
          in: query
          description: Filter by farmer wallet address
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{40}$'
        - name: limit
          in: query
          description: Number of results per page
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Successfully retrieved lots
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  count:
                    type: integer
                    example: 42
                  lots:
                    type: array
                    items:
                      $ref: '#/components/schemas/PepperLot'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    post:
      tags:
        - Lots
      summary: Create a new pepper lot
      description: Register a new pepper lot with harvest information
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLotRequest'
      responses:
        '201':
          description: Lot created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  lot:
                    $ref: '#/components/schemas/PepperLot'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /lots/{lotId}:
    get:
      tags:
        - Lots
      summary: Get lot by ID
      description: Retrieve detailed information about a specific pepper lot
      parameters:
        - name: lotId
          in: path
          required: true
          description: Unique lot identifier
          schema:
            type: string
            example: LOT-2025-KL-001
      responses:
        '200':
          description: Lot found
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  lot:
                    $ref: '#/components/schemas/PepperLot'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==================== PROCESSING STAGES ====================
  /lots/{lotId}/processing:
    post:
      tags:
        - Lots
      summary: Add processing stage
      description: Record a processing stage (harvest, drying, grading, packaging, storage)
      parameters:
        - name: lotId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessingStage'
      responses:
        '201':
          description: Processing stage added
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  stage:
                    $ref: '#/components/schemas/ProcessingStage'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ==================== CERTIFICATIONS ====================
  /certifications:
    post:
      tags:
        - Certifications
      summary: Add certificate
      description: Upload certificate metadata and IPFS document hash
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Certification'
      responses:
        '201':
          description: Certificate added
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  certification:
                    $ref: '#/components/schemas/Certification'
        '400':
          $ref: '#/components/responses/BadRequest'

  /lots/{lotId}/certifications:
    get:
      tags:
        - Certifications
      summary: Get lot certifications
      description: Retrieve all certificates for a specific lot
      parameters:
        - name: lotId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Certificates retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  certifications:
                    type: array
                    items:
                      $ref: '#/components/schemas/Certification'

  # ==================== COMPLIANCE ====================
  /compliance/check/{lotId}:
    post:
      tags:
        - Compliance
      summary: Run compliance check
      description: |
        Validate lot against destination market requirements.
        Checks organic certification, fumigation, pesticide residue,
        moisture content, packaging standards, and more.
      parameters:
        - name: lotId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                destination:
                  type: string
                  enum: [EU, FDA, MIDDLE_EAST]
                  description: Target export market
                  example: EU
      responses:
        '200':
          description: Compliance check completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== AUCTIONS ====================
  /auctions:
    get:
      tags:
        - Auctions
      summary: Get all auctions
      description: Retrieve list of auctions with filters
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [created, active, ended, settled, failed_compliance]
        - name: farmer
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Auctions retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  auctions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Auction'

    post:
      tags:
        - Auctions
      summary: Create auction
      description: Create a new auction for a compliant lot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAuctionRequest'
      responses:
        '201':
          description: Auction created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  auction:
                    $ref: '#/components/schemas/Auction'
        '400':
          $ref: '#/components/responses/BadRequest'

  /auctions/{auctionId}:
    get:
      tags:
        - Auctions
      summary: Get auction details
      description: Get detailed auction information including bids
      parameters:
        - name: auctionId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Auction details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  auction:
                    $ref: '#/components/schemas/Auction'
                  bids:
                    type: array
                    items:
                      $ref: '#/components/schemas/Bid'

  /auctions/{auctionId}/bids:
    get:
      tags:
        - Auctions
      summary: Get auction bids
      description: Retrieve all bids for a specific auction
      parameters:
        - name: auctionId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Bids retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  bids:
                    type: array
                    items:
                      $ref: '#/components/schemas/Bid'

    post:
      tags:
        - Auctions
      summary: Place bid
      description: |
        Place a bid on an active auction.
        **Note:** This records the bid in database after blockchain confirmation.
        Actual bid is placed via smart contract using Web3.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bidderAddress
                - amount
                - txHash
              properties:
                bidderAddress:
                  type: string
                  pattern: '^0x[a-fA-F0-9]{40}$'
                  example: '0x70997970C51812dc3A010C7d01b50e0d17dc79C8'
                amount:
                  type: string
                  description: Bid amount in ETH
                  example: '0.0123'
                txHash:
                  type: string
                  pattern: '^0x[a-fA-F0-9]{64}$'
                  description: Blockchain transaction hash
                  example: '0xabc123...'
      responses:
        '201':
          description: Bid recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  bid:
                    $ref: '#/components/schemas/Bid'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ==================== USERS ====================
  /users/{address}:
    get:
      tags:
        - Users
      summary: Get user by address
      description: Retrieve user profile by wallet address
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{40}$'
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  user:
                    $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'

  /users:
    post:
      tags:
        - Users
      summary: Create/update user
      description: Create new user or update existing profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '200':
          description: User created/updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  user:
                    $ref: '#/components/schemas/User'

# ==================== COMPONENTS ====================
components:
  schemas:
    PepperLot:
      type: object
      properties:
        id:
          type: string
          format: uuid
        lot_id:
          type: string
          example: LOT-2025-KL-001
        farmer_id:
          type: string
          format: uuid
        farmer_address:
          type: string
          pattern: '^0x[a-fA-F0-9]{40}$'
        variety:
          type: string
          example: Tellicherry
        quantity:
          type: number
          format: decimal
          example: 1000.50
        quality:
          type: string
          enum: [A, AA, AAA, Premium]
        harvest_date:
          type: string
          format: date
        origin:
          type: string
          example: Kerala, India
        farm_location:
          type: string
        organic_certified:
          type: boolean
        metadata_uri:
          type: string
        certificate_hash:
          type: string
        certificate_ipfs_url:
          type: string
          example: ipfs://QmX4x7...
        status:
          type: string
          enum: [available, in_auction, sold, expired]
        blockchain_tx_hash:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateLotRequest:
      type: object
      required:
        - lotId
        - farmerAddress
        - variety
        - quantity
        - harvestDate
        - origin
      properties:
        lotId:
          type: string
        farmerAddress:
          type: string
          pattern: '^0x[a-fA-F0-9]{40}$'
        variety:
          type: string
        quantity:
          type: number
        quality:
          type: string
        harvestDate:
          type: string
          format: date
        origin:
          type: string
        farmLocation:
          type: string
        organicCertified:
          type: boolean

    ProcessingStage:
      type: object
      required:
        - stageType
        - stageName
        - timestamp
      properties:
        id:
          type: string
          format: uuid
        lot_id:
          type: string
        stage_type:
          type: string
          enum: [harvest, drying, grading, packaging, storage]
        stage_name:
          type: string
        location:
          type: string
        timestamp:
          type: string
          format: date-time
        operator_name:
          type: string
        quality_metrics:
          type: object
          description: JSONB field for stage-specific metrics
          example:
            moisture: '12.0'
            temperature: '25'
            package_material: 'HDPE'
        notes:
          type: string
        blockchain_tx_hash:
          type: string

    Certification:
      type: object
      required:
        - lotId
        - certType
        - certNumber
        - issuer
        - issueDate
        - expiryDate
      properties:
        id:
          type: string
          format: uuid
        lot_id:
          type: string
        cert_type:
          type: string
          enum: [organic, fumigation, export, quality, phytosanitary, pesticide_test, halal, origin]
          description: |
            Certificate types:
            - `organic`: EU organic certification
            - `fumigation`: Fumigation treatment certificate
            - `phytosanitary`: FDA phytosanitary certificate
            - `pesticide_test`: Pesticide residue lab test (NEW)
            - `halal`: Halal certification for Middle East (NEW)
            - `origin`: Certificate of origin for customs (NEW)
        cert_number:
          type: string
          example: ORG-2025-KL-001
        issuer:
          type: string
          example: Organic Lanka
        issue_date:
          type: string
          format: date
        expiry_date:
          type: string
          format: date
        document_hash:
          type: string
          description: SHA-256 hash for blockchain verification
          pattern: '^0x[a-fA-F0-9]{64}$'
        ipfs_url:
          type: string
          description: IPFS URL to certificate document
          example: ipfs://QmX4x7abc123...
        is_valid:
          type: boolean
        verification_status:
          type: string
          enum: [pending, verified, rejected, expired]

    ComplianceResult:
      type: object
      properties:
        success:
          type: boolean
        complianceStatus:
          type: string
          enum: [passed, failed]
        results:
          type: array
          items:
            type: object
            properties:
              code:
                type: string
                example: EU_MOISTURE_LIMIT
              name:
                type: string
              category:
                type: string
                enum: [certification, quality, packaging, traceability]
              severity:
                type: string
                enum: [critical, major, minor]
              passed:
                type: boolean
              details:
                type: string
                example: Moisture 12.0% meets EU limit (‚â§12.5%)
        timestamp:
          type: string
          format: date-time

    Auction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        auction_id:
          type: integer
        lot_id:
          type: string
        farmer_address:
          type: string
        start_price:
          type: string
          description: Price in wei (1 ETH = 1e18 wei)
          example: '1000000000000000'
        reserve_price:
          type: string
        current_bid:
          type: string
        current_bidder_address:
          type: string
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
        status:
          type: string
          enum: [created, active, ended, settled, failed_compliance]
        compliance_passed:
          type: boolean
        bid_count:
          type: integer
        created_at:
          type: string
          format: date-time

    CreateAuctionRequest:
      type: object
      required:
        - lotId
        - farmerAddress
        - startPrice
        - reservePrice
        - startTime
        - endTime
      properties:
        lotId:
          type: string
        farmerAddress:
          type: string
        startPrice:
          type: string
          description: In ETH
        reservePrice:
          type: string
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time

    Bid:
      type: object
      properties:
        id:
          type: string
          format: uuid
        auction_id:
          type: integer
        bidder_address:
          type: string
        amount:
          type: string
          description: Bid amount in wei
        blockchain_tx_hash:
          type: string
        timestamp:
          type: string
          format: date-time

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        wallet_address:
          type: string
        user_type:
          type: string
          enum: [farmer, buyer, exporter, regulator]
        name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        location:
          type: object
        verified:
          type: boolean
        created_at:
          type: string
          format: date-time

    CreateUserRequest:
      type: object
      required:
        - walletAddress
        - userType
      properties:
        walletAddress:
          type: string
        userType:
          type: string
          enum: [farmer, buyer, exporter, regulator]
        name:
          type: string
        email:
          type: string
        phone:
          type: string
        location:
          type: object

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: Invalid input parameters

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: Resource not found

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: Internal server error

  securitySchemes:
    WalletAuth:
      type: apiKey
      in: header
      name: X-Wallet-Address
      description: Wallet address for authentication (future: JWT tokens)
